import streamlit as st
import requests
import json
import pandas as pd

# --- 1. ‡∏ï‡∏±‡πâ‡∏á‡∏Ñ‡πà‡∏≤‡∏´‡∏ô‡πâ‡∏≤‡πÄ‡∏ß‡πá‡∏ö ---
st.set_page_config(page_title="Sensor Team Dashboard", page_icon="‚öôÔ∏è", layout="wide")

# --- 2. ‡∏î‡∏∂‡∏á‡∏Å‡∏∏‡∏ç‡πÅ‡∏à‡∏•‡∏±‡∏ö‡∏à‡∏≤‡∏Å‡∏ï‡∏π‡πâ‡πÄ‡∏ã‡∏ü ---
GAS_URL = st.secrets["GAS_URL"]
SHEET_URL = st.secrets["SHEET_URL"]

# --- 3. ‡∏™‡∏£‡πâ‡∏≤‡∏á‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡πÅ‡∏ñ‡∏ö‡∏î‡πâ‡∏≤‡∏ô‡∏Ç‡πâ‡∏≤‡∏á (Sidebar) ---
st.sidebar.title("üõ†Ô∏è Sensor Team Menu")
menu = st.sidebar.radio("‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÄ‡∏°‡∏ô‡∏π‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô:", [
    "üìç 1. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Monthly Overview)",
    "üè¢ 2. ‡πÄ‡∏à‡∏≤‡∏∞‡∏•‡∏∂‡∏Å‡∏£‡∏≤‡∏¢‡πÑ‡∏ã‡∏ï‡πå (Site Detail)",
    "üì± 3. ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (My Workload)",
    "üìä 4. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ó‡∏µ‡∏° (Team Manager)",
    "üß∞ 5. ‡∏£‡∏∞‡∏ö‡∏ö‡πÄ‡∏ö‡∏¥‡∏Å-‡∏Ñ‡∏∑‡∏ô‡∏≠‡∏∏‡∏õ‡∏Å‡∏£‡∏ì‡πå (Tools)",
    "üë• 6. ‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏ó‡∏µ‡∏° (Team Profile)",
    "üß† 7. ‡∏®‡∏π‡∏ô‡∏¢‡πå‡∏Å‡∏≤‡∏£‡πÄ‡∏£‡∏µ‡∏¢‡∏ô‡∏£‡∏π‡πâ (Learning & Quiz)",
    "üìö 8. ‡∏Ñ‡∏π‡πà‡∏°‡∏∑‡∏≠‡∏Å‡∏≤‡∏£‡πÉ‡∏ä‡πâ‡∏á‡∏≤‡∏ô (Manuals & Docs)"
])

st.sidebar.markdown("---")
st.sidebar.info("üë®‚Äçüíª ‡πÄ‡∏Ç‡πâ‡∏≤‡∏™‡∏π‡πà‡∏£‡∏∞‡∏ö‡∏ö‡πÇ‡∏î‡∏¢: **Heart**")

# --- 4. ‡πÇ‡∏Ñ‡∏£‡∏á‡∏™‡∏£‡πâ‡∏≤‡∏á‡πÅ‡∏ï‡πà‡∏•‡∏∞‡πÄ‡∏°‡∏ô‡∏π ---
if menu == "üìç 1. ‡∏†‡∏≤‡∏û‡∏£‡∏ß‡∏°‡πÅ‡∏•‡∏∞‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà (Monthly Overview)":
    st.title("üìç ‡πÅ‡∏î‡∏ä‡∏ö‡∏≠‡∏£‡πå‡∏î‡∏õ‡∏£‡∏∞‡∏à‡∏≥‡πÄ‡∏î‡∏∑‡∏≠‡∏ô (Monthly Overview)")
    st.write("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤: ‡∏£‡∏∞‡∏ö‡∏ö‡∏à‡∏∞‡∏î‡∏∂‡∏á‡πÅ‡∏ú‡∏ô‡∏ó‡∏µ‡πà‡πÅ‡∏•‡∏∞‡πÑ‡∏ã‡∏ï‡πå‡∏ó‡∏µ‡πà‡∏ï‡πâ‡∏≠‡∏á PM ‡πÉ‡∏ô‡πÄ‡∏î‡∏∑‡∏≠‡∏ô‡∏ô‡∏µ‡πâ‡∏°‡∏≤‡πÅ‡∏™‡∏î‡∏á‡∏ó‡∏µ‡πà‡∏ô‡∏µ‡πà")

elif menu == "üì± 3. ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß (My Workload)":
    st.title("üì± ‡∏Å‡∏£‡∏∞‡∏î‡∏≤‡∏ô‡∏á‡∏≤‡∏ô‡∏™‡πà‡∏ß‡∏ô‡∏ï‡∏±‡∏ß")
    st.write("‡∏´‡∏ô‡πâ‡∏≤‡∏ï‡πà‡∏≤‡∏á‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡∏î‡∏π‡∏á‡∏≤‡∏ô‡∏Ç‡∏≠‡∏á‡∏ï‡∏±‡∏ß‡πÄ‡∏≠‡∏á ‡πÅ‡∏•‡∏∞‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô")
    
    # ‡∏î‡∏∂‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ó‡∏µ‡∏°‡∏á‡∏≤‡∏ô‡∏ó‡∏±‡πâ‡∏á‡∏´‡∏°‡∏î
    team_members = ["Heart", "Phubeth", "Mink", "Film", "Folk", "Chan"]
    
    st.markdown("### ‚ûï ‡∏ü‡∏≠‡∏£‡πå‡∏°‡πÅ‡∏à‡πâ‡∏á‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô / ‡∏≠‡∏±‡∏õ‡πÄ‡∏î‡∏ï‡∏á‡∏≤‡∏ô")
    with st.form("task_form"):
        col1, col2 = st.columns(2)
        
        with col1:
            site_name = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå‡∏á‡∏≤‡∏ô", placeholder="‡πÄ‡∏ä‡πà‡∏ô CPN ‡∏≠‡∏¢‡∏∏‡∏ò‡∏¢‡∏≤")
            task_detail = st.text_input("‡∏ä‡∏∑‡πà‡∏≠‡∏á‡∏≤‡∏ô / ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î", placeholder="‡πÄ‡∏ä‡πà‡∏ô ‡πÄ‡∏Ç‡πâ‡∏≤‡πÑ‡∏õ‡πÄ‡∏õ‡∏•‡∏µ‡πà‡∏¢‡∏ô‡∏ã‡∏¥‡∏°‡πÄ‡∏£‡πâ‡∏≤‡πÄ‡∏ï‡∏≠‡∏£‡πå")
            task_type = st.selectbox("‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô", ["‡∏á‡∏≤‡∏ô‡∏î‡πà‡∏ß‡∏ô", "‡∏á‡∏≤‡∏ô‡∏ï‡∏≤‡∏°‡πÅ‡∏û‡∏•‡∏ô", "‡∏á‡∏≤‡∏ô‡πÇ‡∏õ‡∏£‡πÄ‡∏à‡∏Å‡∏ï‡πå"])
            status = st.selectbox("‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô", ["Planning", "In progress", "Problem", "Complete"])
            
        with col2:
            start_date = st.date_input("‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥ (Scheduled Date)")
            end_date = st.date_input("‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à (Deadline)")
            assignee = st.selectbox("‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å", team_members)
            # ‡πÄ‡∏û‡∏¥‡πà‡∏°‡∏ä‡πà‡∏≠‡∏á‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ (‡πÄ‡∏•‡∏∑‡∏≠‡∏Å‡πÑ‡∏î‡πâ‡∏´‡∏•‡∏≤‡∏¢‡∏Ñ‡∏ô)
            assistants = st.multiselect("‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢ (‡∏ñ‡πâ‡∏≤‡∏°‡∏µ)", team_members)
            
        submitted = st.form_submit_button("‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡∏•‡∏á‡∏ï‡∏≤‡∏£‡∏≤‡∏á", type="primary")
        
        if submitted:
            if site_name and task_detail:
                # ‡πÅ‡∏õ‡∏•‡∏á‡∏£‡∏≤‡∏¢‡∏ä‡∏∑‡πà‡∏≠‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢‡πÉ‡∏´‡πâ‡πÄ‡∏õ‡πá‡∏ô‡∏Ç‡πâ‡∏≠‡∏Ñ‡∏ß‡∏≤‡∏°‡∏Ñ‡∏±‡πà‡∏ô‡∏î‡πâ‡∏ß‡∏¢‡∏•‡∏π‡∏Å‡∏ô‡πâ‡∏≥ ‡πÄ‡∏ä‡πà‡∏ô "Base, Mink"
                assistants_str = ", ".join(assistants)
                
                # ‡πÄ‡∏ï‡∏£‡∏µ‡∏¢‡∏°‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÉ‡∏´‡πâ‡∏ï‡∏£‡∏á‡∏Å‡∏±‡∏ö 9 ‡∏Ñ‡∏≠‡∏•‡∏±‡∏°‡∏ô‡πå‡πÉ‡∏ô GSheet ‡πÅ‡∏ú‡πà‡∏ô Task & Workload
                payload = {
                    "sheet": "Task & Workload",
                    "data": [
                        pd.Timestamp.now().strftime("%Y-%m-%d %H:%M:%S"), # A: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å
                        site_name,                                        # B: ‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå‡∏á‡∏≤‡∏ô
                        task_detail,                                      # C: ‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î
                        task_type,                                        # D: ‡∏õ‡∏£‡∏∞‡πÄ‡∏†‡∏ó‡∏á‡∏≤‡∏ô
                        start_date.strftime("%d/%m/%Y"),                  # E: ‡∏ß‡∏±‡∏ô‡∏ó‡∏µ‡πà‡πÄ‡∏Ç‡πâ‡∏≤‡∏ó‡∏≥
                        end_date.strftime("%d/%m/%Y"),                    # F: ‡∏Å‡∏≥‡∏´‡∏ô‡∏î‡πÄ‡∏™‡∏£‡πá‡∏à
                        status,                                           # G: ‡∏™‡∏ñ‡∏≤‡∏ô‡∏∞‡∏á‡∏≤‡∏ô
                        assignee,                                         # H: ‡∏ú‡∏π‡πâ‡∏£‡∏±‡∏ö‡∏ú‡∏¥‡∏î‡∏ä‡∏≠‡∏ö‡∏´‡∏•‡∏±‡∏Å
                        assistants_str                                    # I: ‡∏ú‡∏π‡πâ‡∏ä‡πà‡∏ß‡∏¢
                    ]
                }
                
                with st.spinner("‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏™‡πà‡∏á‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•‡πÄ‡∏Ç‡πâ‡∏≤‡∏ï‡∏≤‡∏£‡∏≤‡∏á..."):
                    try:
                        response = requests.post(GAS_URL, data=json.dumps(payload))
                        result = response.json()
                        
                        # ‡πÄ‡∏ä‡πá‡∏Ñ‡∏ß‡πà‡∏≤ Google Script ‡∏ï‡∏≠‡∏ö‡∏Å‡∏•‡∏±‡∏ö‡∏°‡∏≤‡∏ß‡πà‡∏≤ success ‡∏à‡∏£‡∏¥‡∏á‡πÜ ‡πÑ‡∏´‡∏°
                        if result.get("status") == "success":
                            st.success(f"‡∏ö‡∏±‡∏ô‡∏ó‡∏∂‡∏Å‡∏á‡∏≤‡∏ô '{task_detail}' ‡∏ó‡∏µ‡πà '{site_name}' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏∏‡∏ì {assignee} ‡πÄ‡∏£‡∏µ‡∏¢‡∏ö‡∏£‡πâ‡∏≠‡∏¢‡πÅ‡∏•‡πâ‡∏ß! üéâ")
                        else:
                            st.error(f"‡πÄ‡∏Å‡∏¥‡∏î‡∏Ç‡πâ‡∏≠‡∏ú‡∏¥‡∏î‡∏û‡∏•‡∏≤‡∏î‡∏à‡∏≤‡∏Å‡∏ê‡∏≤‡∏ô‡∏Ç‡πâ‡∏≠‡∏°‡∏π‡∏•: {result.get('message')}")
                    except Exception as e:
                        st.error(f"‡∏£‡∏∞‡∏ö‡∏ö‡∏Ç‡∏±‡∏î‡∏Ç‡πâ‡∏≠‡∏á: {e}")
            else:
                st.warning("‚ö†Ô∏è ‡∏Å‡∏£‡∏∏‡∏ì‡∏≤‡∏Å‡∏£‡∏≠‡∏Å '‡∏ä‡∏∑‡πà‡∏≠‡πÑ‡∏ã‡∏ï‡πå‡∏á‡∏≤‡∏ô' ‡πÅ‡∏•‡∏∞ '‡∏£‡∏≤‡∏¢‡∏•‡∏∞‡πÄ‡∏≠‡∏µ‡∏¢‡∏î‡∏á‡∏≤‡∏ô' ‡πÉ‡∏´‡πâ‡∏Ñ‡∏£‡∏ö‡∏ñ‡πâ‡∏ß‡∏ô‡∏Ñ‡∏£‡∏±‡∏ö")

else:
    st.title(menu)
    st.write(f"‡∏Å‡∏≥‡∏•‡∏±‡∏á‡∏û‡∏±‡∏í‡∏ô‡∏≤‡∏ü‡∏µ‡πÄ‡∏à‡∏≠‡∏£‡πå‡∏™‡∏≥‡∏´‡∏£‡∏±‡∏ö‡πÄ‡∏°‡∏ô‡∏π‡∏ô‡∏µ‡πâ‡∏Ñ‡∏£‡∏±‡∏ö...")
